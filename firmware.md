### QEMU的运行模式：

#### 1、用户模式
用户模式仅模拟目标架构的用户空间指令执行，即将一种平台上的二进制指令转换为主机上的指令，而不涉及外围设备的模拟，所以有些与外设紧密相关的功能无法在用户模式下运行。用户模式的优点是快速和高效。
target指令->TCG IR -> HOST指令
#### 2、全系统仿真
全系统仿真主要用于虚拟化整个操作系统和硬件环境，允许在一个虚拟的环境中运行不同架构的操作系统。相对于用户模式，全系统仿真的性能较低，因为它需要模拟整个系统的硬件和操作系统，涉及更多的指令转换和处理。
##### 1）、QEMU-KVM
QEMU-KVM通过Linux的KVM虚拟化子系统使用CPU支持硬件虚拟化。
##### 2）、QEMU-TCG
target指令->TCG IR -> HOST指令（多了一些和硬件交互的指令，比较复杂）
##### PANDA 
![image](https://github.com/Cyber-Security-Team/binary_function_similarity/blob/main/image/PANDA.png)

固件有设备固件、更新固件等，但是我们的目标是有嵌入式操作系统的固件，如路由器、智能家居中的固件。
### 固件中的程序
![image](https://github.com/Cyber-Security-Team/binary_function_similarity/blob/main/image/%E5%9B%BA%E4%BB%B6.png)

常用的模糊测试的方法：
污染分析：只变异这些关键数据字节来生成输入。
符号执行：符号执行的结果是得到一组关于输入的约束条件的逻辑表达式，然后用约束求解器来求解约束，得到满足条件的具体值。
字典模糊测试：所有测试用例都是事先以字典的形式准备好，一般不会进行编译。有针对性地去进行测试，但是也会探索不到一些边界情况。
路径导向（基于反馈的）：AFL
状态感知（基于反馈）：StateFuzz
### FIRM-AFL
在用户模式仿真和全系统仿真间进行切换，初始固件在全系统仿真下运行，进行到被测程序主函数入口时，切换到用户仿真，中间需要系统调用的时候，切换回全系统仿真与外设交互，交互结束再返回用户仿真进行。

### QEMU仿真三种内存访问方式
#### 1、MMIO方式
添加反映真实硬件上的PCI内存布局的内存映射区域。每当客户操作系统访问这些MMIO区域时，QEMU都会查询我们的仿真设备，该设备将MMIO读取转发给模糊核心。
#### 2、I/O端口方式
QEMU将端口I/O空间实现为其自己的地址空间中的另一个内存区域
#### 3、DMA方式
需要根据不同的设备和设备驱动程序进行相应改变。
